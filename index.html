<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF to Excel Converter (All Data Preserved)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    #output { margin-top: 1rem; border: 1px solid #ccc; padding: 1rem; overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
    th, td { border: 1px solid #aaa; padding: 4px 8px; white-space: nowrap; }
    th { font-weight: bold; background: #f2f2f2; text-align: center; }
  </style>
</head>
<body>
  <h2>PDF to Excel Converter (Preserve All Data)</h2>
  <input type="file" id="pdfUpload" accept="application/pdf">
  <button onclick="exportToExcel()">Export to Excel</button>

  <div id="output">Extracted content will appear here...</div>

  <script>
    let extractedPages = [];

    document.getElementById('pdfUpload').addEventListener('change', handleFile);

    async function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const typedarray = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
        extractedPages = [];
        const outputDiv = document.getElementById('output');
        outputDiv.innerHTML = '';

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const text = await page.getTextContent();

          // group by line (Y coordinate)
          const rows = {};
          text.items.forEach(item => {
            const y = Math.round(item.transform[5]);
            if (!rows[y]) rows[y] = [];
            rows[y].push({ x: item.transform[4], str: item.str });
          });

          const sortedRows = Object.keys(rows).sort((a, b) => b - a);

          // collect all X positions for consistent columns
          let allX = [];
          Object.values(rows).forEach(r => r.forEach(cell => allX.push(cell.x)));
          allX.sort((a, b) => a - b);

          const colThreshold = 15;
          let colPositions = [allX[0]];
          for (let j = 1; j < allX.length; j++) {
            if (allX[j] - colPositions[colPositions.length - 1] > colThreshold) {
              colPositions.push(allX[j]);
            }
          }

          let pageData = [];
          sortedRows.forEach(y => {
            const rowCells = new Array(colPositions.length).fill("");
            rows[y].forEach(cell => {
              let colIdx = colPositions.findIndex(px => cell.x <= px + colThreshold);
              if (colIdx === -1) colIdx = colPositions.length - 1;
              rowCells[colIdx] += (rowCells[colIdx] ? " " : "") + cell.str.trim();
            });
            pageData.push(rowCells);
          });

          extractedPages.push(pageData);

          // Preview HTML
          let htmlTable = '<h4>Page ' + i + '</h4><table>';
          pageData.forEach(r => {
            htmlTable += '<tr>' + r.map(c => `<td>${c}</td>`).join('') + '</tr>';
          });
          htmlTable += '</table>';
          outputDiv.innerHTML += htmlTable;
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function exportToExcel() {
      if (extractedPages.length === 0) {
        alert("No data extracted yet.");
        return;
      }

      const wb = XLSX.utils.book_new();
      extractedPages.forEach((pageData, idx) => {
        const ws = XLSX.utils.aoa_to_sheet(pageData);

        // auto column widths
        const colWidths = [];
        pageData.forEach(row => {
          row.forEach((cell, i) => {
            const len = cell ? cell.toString().length : 0;
            colWidths[i] = Math.max(colWidths[i] || 10, len + 2);
          });
        });
        ws['!cols'] = colWidths.map(w => ({ wch: w }));

        XLSX.utils.book_append_sheet(wb, ws, `Page_${idx+1}`);
      });

      XLSX.writeFile(wb, "output.xlsx");
    }
  </script>
</body>
</html>
